<script>
  // Demo codes mapped to testers with interaction and minute limits
  const demoCodes = {
    "ADAM2025": { interactions: 12, minutes: 10 },
    "ABDULVIP": { interactions: 8, minutes: 10 },
    "ANDYTRIAL": { interactions: 10, minutes: 10 },
    "CEDGROWTH": { interactions: 7, minutes: 10 }
  };

  let activeCode = '';
  let interactionsLeft = 0;
  let minutesLeft = 0;
  let timerInterval;

  const accessCodeInput = document.getElementById("accessCode");
  const validateBtn = document.getElementById("validateBtn");
  const messageDiv = document.getElementById("message");
  const agentArea = document.getElementById("agentArea");
  const remainingSpan = document.getElementById("remaining");
  const codeEntryArea = document.getElementById("code-entry-area");

  function loadUsage(code) {
    const use = JSON.parse(localStorage.getItem("agent_usage_" + code));
    if (use && typeof use.interactions === 'number' && typeof use.minutes === 'number') {
      interactionsLeft = use.interactions;
      minutesLeft = use.minutes;
    } else {
      interactionsLeft = demoCodes[code].interactions;
      minutesLeft = demoCodes[code].minutes;
    }
  }

  function saveUsage(code) {
    localStorage.setItem(
      "agent_usage_" + code,
      JSON.stringify({ interactions: interactionsLeft, minutes: minutesLeft })
    );
  }

  function startTimer() {
    timerInterval = setInterval(() => {
      if (minutesLeft > 0) {
        minutesLeft -= 1;
        saveUsage(activeCode);
        if (minutesLeft === 0) {
          clearInterval(timerInterval);
          alert("Your demo session has ended due to time limit.");
          lockOutUser("Time limit reached. Please contact us to upgrade.");
        }
      }
    }, 60000); // Trigger every minute
  }

  function decreaseInteraction() {
    if (interactionsLeft > 0) {
      interactionsLeft -= 1;
      remainingSpan.textContent = interactionsLeft;
      saveUsage(activeCode);
      if (interactionsLeft === 0) {
        alert("Your demo session has ended due to interaction limit.");
        lockOutUser("Interaction limit reached. Please contact us to upgrade.");
      }
    }
  }

  function lockOutUser(reason) {
    agentArea.style.display = "none";
    messageDiv.style.color = "#dc2626";
    messageDiv.textContent = reason;
    codeEntryArea.style.display = "block";
    clearInterval(timerInterval);
  }

  validateBtn.addEventListener("click", () => {
    const code = accessCodeInput.value.trim().toUpperCase();
    if (!code) {
      messageDiv.textContent = "Please enter a demo access code.";
      messageDiv.style.color = "#dc2626";
      return;
    }
    if (demoCodes[code]) {
      activeCode = code;
      loadUsage(code);
      if (interactionsLeft === 0 || minutesLeft === 0) {
        lockOutUser("Your demo period has expired. Please contact us to upgrade.");
        return;
      }
      remainingSpan.textContent = interactionsLeft;
      codeEntryArea.style.display = "none";
      agentArea.style.display = "block";
      messageDiv.textContent = "";
      startTimer();
    } else {
      messageDiv.textContent = "Invalid demo code. Please try again or contact support.";
      messageDiv.style.color = "#dc2626";
    }
  });

  // For real deployment: Call decreaseInteraction() when user sends a message
  // For demo/testing: Uncomment below to simulate (every 30 seconds)
  /*
  setInterval(() => {
    if (agentArea.style.display === "block" && interactionsLeft > 0) {
      decreaseInteraction();
    }
  }, 30000);
  */

  // Optional: Automatically reload remaining uses when reloading page
  window.addEventListener("DOMContentLoaded", () => {
    // If user previously entered a valid code, load its usage
    for (let code in demoCodes) {
      if (localStorage.getItem("agent_usage_" + code)) {
        activeCode = code;
        loadUsage(code);
        if (interactionsLeft > 0 && minutesLeft > 0) {
          remainingSpan.textContent = interactionsLeft;
          codeEntryArea.style.display = "none";
          agentArea.style.display = "block";
          startTimer();
        }
        break;
      }
    }
  });
</script>
